name: Build Windows (pyside6-deploy)
on: [push, workflow_dispatch]

jobs:
  build-win:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"   # 或 3.11，記得是 x64（預設即 x64）

      - name: Setup venv and install deps
        shell: cmd
        run: |
          python -m venv .venv
          call .venv\Scripts\activate
          python -m pip install --upgrade pip
          pip install --upgrade pyside6

      - name: Init deploy config (first time only)
        if: ${{ hashFiles('pyside6-deploy.json') == '' }}
        shell: cmd
        run: |
          call .venv\Scripts\activate
          pyside6-deploy --init main.py --force

      - name: Build with pyside6-deploy
        shell: cmd
        run: |
          call .venv\Scripts\activate
          pyside6-deploy pyside6-deploy.json --force

      - name: List deploy output
        shell: cmd
        run: |
          echo === Listing possible output ===
          if exist pyside6_deploy (dir /s /b pyside6_deploy) else (echo pyside6_deploy not found)
          if exist dist (dir /s /b dist)
          where /R . *.exe

      - name: Locate dist folder
        id: finddist
        shell: pwsh
        run: |
          $distDirs = Get-ChildItem -Path . -Recurse -Directory -Filter dist | Select-Object -ExpandProperty FullName
          if (-not $distDirs) { Write-Error "No dist directories found"; exit 1 }
          $preferred = $distDirs | Where-Object { $_ -match 'pyside6_deploy' } | Select-Object -First 1
          if ($preferred) { $chosen = $preferred } else { $chosen = $distDirs[0] }
          "distPath=$chosen" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Host "Using dist path: $chosen"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: AudioSocketClient-win
          path: ${{ steps.finddist.outputs.distPath }}\**